<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××“×¤×¡×ª ××“×‘×§×•×ª ×©×˜×— (×¡××‘×§×•)</title>
    
    <style>
        /* ×¢×™×¦×•×‘ ×¤× ×™××™ */
        :root { --primary: #2563eb; --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; direction: rtl; }
        .container { max-width: 600px; margin: 0 auto; background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        h1 { text-align: center; color: var(--primary); margin-top: 0; font-size: 1.5rem; }
        .version-tag { font-size: 0.8rem; color: #666; display: block; margin-top: -5px; margin-bottom: 15px; }

        h2 { font-size: 1.2rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px; margin-top: 20px; }

        button {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            font-size: 1rem; font-weight: bold; cursor: pointer; color: white;
            margin-top: 8px;
        }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .btn-primary { background: #2563eb; }
        .btn-danger { background: #dc2626; }
        .btn-outline { background: transparent; border: 2px solid #2563eb; color: #2563eb; }

        input, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }

        #statusMessage { padding: 12px; border-radius: 8px; text-align: center; margin-bottom: 15px; font-weight: bold; background: #e0f2fe; color: #0369a1; }
        .success { background: #dcfce7 !important; color: #15803d !important; }
        .error { background: #fee2e2 !important; color: #b91c1c !important; }

        /* ×ª×¦×•×’×” ××§×“×™××” */
        #previewArea { background: #e5e7eb; padding: 20px; border-radius: 8px; display: flex; justify-content: center; min-height: 160px; }

        /* ××“×‘×§×” */
        .label { width: 30mm; height: 30mm; background: white; border: 1px solid black; padding: 2mm; box-sizing: border-box; display: flex; flex-direction: column; justify-content: space-between; }
        .label-header { font-size: 9pt; font-weight: bold; }
        .label-desc { font-size: 8pt; line-height: 1.1; max-height: 2.4em; overflow: hidden; }
        .label-footer { margin-top: auto; border-top: 1px solid #ccc; padding-top: 2px; }
        .label-price { font-size: 13pt; font-weight: 900; text-align: center; direction: ltr; }
        .label-importer { font-size: 5pt; text-align: right; }

        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; }
            .label { border: none; page-break-after: always; margin: 0; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>××“×¤×¡×ª ××“×‘×§×•×ª ×©×˜×— <span class="version-tag">(×’×¨×¡×”: ×¡×•×¨×§ ×—×™×¦×•× ×™)</span></h1>
    
    <div id="statusMessage">×× × ×˜×¢×Ÿ ××—×™×¨×•×Ÿ ×›×“×™ ×œ×”×ª×—×™×œ.</div>

    <!-- ×˜×¢×™× ×” -->
    <div style="background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #eee;">
        <h2>1. ×˜×¢×™× ×ª ××—×™×¨×•×Ÿ</h2>
        <div style="display: flex; gap: 10px;">
            <input type="file" id="jsonFile" accept=".json" style="display:none" onchange="handleFileLoad(event)">
            <button class="btn-primary" onclick="document.getElementById('jsonFile').click()">ğŸ“‚ ×‘×—×¨ ×§×•×‘×¥</button>
            <button class="btn-outline" onclick="loadSampleData()">×˜×¢×Ÿ ×“×•×’××”</button>
        </div>
        <textarea id="jsonInput" rows="1" placeholder="××• ×”×“×‘×§ JSON ×›××Ÿ" style="display:none"></textarea>
    </div>

    <!-- ×‘×™×¦×•×¢ -->
    <div style="margin-top: 20px;">
        <h2>2. ×¡×¨×™×§×” ×•×”×“×¤×¡×”</h2>
        
        <!-- ×›×¤×ª×•×¨ ×¡×¨×™×§×” ×—×™×¦×•× ×™×ª -->
        <button id="scanButton" class="btn-primary" disabled onclick="openExternalScanner()">
            ğŸ“² ×¡×¨×•×§ ×‘××¤×œ×™×§×¦×™×” ×—×™×¦×•× ×™×ª
        </button>
        <p style="font-size: 0.8rem; color: #666; text-align: center; margin-top: 5px;">
            (×—×•×‘×” ×©×ª×”×™×” ××•×ª×§× ×ª ××¤×œ×™×§×¦×™×™×ª Binary Eye ××• Barcode Scanner)
        </p>

        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <input type="text" id="inputSku" placeholder="××§''×˜ ×™×“× ×™" oninput="updatePreview()">
            <input type="number" id="inputQuantity" value="1" min="1" placeholder="×›××•×ª" style="width: 80px;" oninput="updatePreview()">
        </div>

        <button id="printButton" class="btn-danger" disabled onclick="printLabels()" style="margin-top: 15px;">
            ğŸ–¨ï¸ ×”×“×¤×¡ ××“×‘×§×•×ª
        </button>
    </div>

    <!-- ×ª×¦×•×’×” -->
    <div style="margin-top: 20px;">
        <h2>3. ×ª×¦×•×’×” ××§×“×™××”</h2>
        <div id="previewArea"><span style="color: #888;">×”××“×‘×§×” ×ª×•×¤×™×¢ ×›××Ÿ...</span></div>
    </div>
</div>

<div id="printArea"></div>

<script>
    let priceMap = new Map();
    const IMPORTER_INFO = { lines: ["×™×‘×•××Ÿ: ×¡××‘×§×• ××¡×¤×§×” ×˜×›× ×™×ª ×‘×¢\"×", "×›×ª×•×‘×ª: ×—×•×¦×•×ª ×”×™×•×¦×¨ 13 ××©×§×œ×•×Ÿ", "×™×¦×¨×Ÿ: ×˜×¨×•×¤×¨ | ××¨×¥ ×™×™×¦×•×¨: ×¡×™×Ÿ"] };

    function setStatus(msg, type) {
        const el = document.getElementById('statusMessage');
        el.textContent = msg;
        el.className = type || '';
    }

    function loadData(jsonString) {
        if (!jsonString) return;
        try {
            const data = JSON.parse(jsonString);
            if (!Array.isArray(data)) throw new Error("×¤×•×¨××˜ ×©×’×•×™");
            priceMap.clear();
            data.forEach(item => {
                if (item.sku) {
                    item.price = parseFloat(item.price);
                    priceMap.set(String(item.sku).trim().toUpperCase(), item);
                    if (item.barcode) priceMap.set(String(item.barcode).trim(), item);
                }
            });
            localStorage.setItem('priceMapJSON', jsonString);
            setStatus(`âœ… × ×˜×¢×Ÿ: ${priceMap.size} ×¤×¨×™×˜×™×`, 'success');
            document.getElementById('scanButton').disabled = false;
            document.getElementById('printButton').disabled = false;
        } catch (e) { setStatus('×©×’×™××” ×‘× ×ª×•× ×™×', 'error'); }
    }

    function handleFileLoad(e) {
        const reader = new FileReader();
        reader.onload = (ev) => loadData(ev.target.result);
        reader.readAsText(e.target.files[0]);
    }

    function loadSampleData() {
        loadData(`[{"sku": "10235", "description": "××¨×¡×¡ ×¤×¨×—×™× 2 ×œ×™×˜×¨", "price": 61, "barcode": "7290000102358"}]`);
    }

    // --- ×¡×•×¨×§ ×—×™×¦×•× ×™ ---
    function openExternalScanner() {
        const currentUrl = window.location.href.split('?')[0];
        const returnUrl = encodeURIComponent(currentUrl + '?code={CODE}');
        window.location.href = 'zxing://scan/?ret=' + returnUrl;
    }

    function checkScanResult() {
        const urlParams = new URLSearchParams(window.location.search);
        const scannedCode = urlParams.get('code');
        if (scannedCode) {
            const cleanCode = scannedCode.trim().toUpperCase();
            document.getElementById('inputSku').value = cleanCode;
            setTimeout(() => {
                const item = priceMap.get(cleanCode);
                if (item) {
                    setStatus(`âœ… × ×¡×¨×§: ${item.description}`, 'success');
                    updatePreview();
                } else {
                    setStatus(`âš ï¸ ×‘×¨×§×•×“ ${cleanCode} ×œ× × ××¦×`, 'error');
                    updatePreview();
                }
            }, 100);
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    }

    function createLabelHTML(item) {
        if (!item) return '';
        return `<div class="label"><div><div class="label-header">××§"×˜: ${item.sku}</div><div class="label-desc">${item.description}</div></div><div class="label-footer"><div class="label-price">â‚ª${item.price.toFixed(2)}</div><div class="label-importer">${IMPORTER_INFO.lines.join('<br>')}</div></div></div>`;
    }

    function updatePreview() {
        const key = document.getElementById('inputSku').value.trim().toUpperCase();
        const container = document.getElementById('previewArea');
        const item = priceMap.get(key);
        container.innerHTML = item ? createLabelHTML(item) : '<span style="color:red">×œ× × ××¦×</span>';
    }

    function printLabels() {
        const key = document.getElementById('inputSku').value.trim().toUpperCase();
        const qty = parseInt(document.getElementById('inputQuantity').value) || 1;
        const item = priceMap.get(key);
        if (!item) { alert('××™×Ÿ ××•×¦×¨'); return; }
        let html = '';
        for(let i=0; i<qty; i++) html += createLabelHTML(item);
        document.getElementById('printArea').innerHTML = html;
        window.print();
    }

    window.onload = () => {
        const saved = localStorage.getItem('priceMapJSON');
        if (saved) loadData(saved);
        checkScanResult();
    };
</script>
</body>
</html>